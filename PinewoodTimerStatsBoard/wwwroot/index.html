<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Pinewood Timer</title>
    <link rel="stylesheet" href="styles/site.css">
    <link rel="stylesheet" href="styles/bootstrap.css">
</head>
<body class="bg-dark">
    <div class="container-fluid bg-dark text-white" data-bind="foreach:tracks">
        <div>
            <h2>Track <span data-bind="text: trackNumber"> </span></h2>
        </div>
        <div class="row">
            <div class="col text-center"><h3>Lane 1</h3></div>
            <div class="col text-center"><h3>Lane 2</h3></div>
            <div class="col text-center"><h3>Lane 3</h3></div>
            <div class="col text-center"><h3>Lane 4</h3></div>
        </div>
        <div class="row" data-bind="foreach:lanes">
            <div class="col text-center"><h1 class="display-xl font-weight-bold" data-bind="visible:place() > 0, text:place, css:{ 'text-primary': place() == 1, 'text-danger': place() == 2, 'text-white': place() == 3, 'text-warning': place() == 4 }">Running</h1></div>
        </div>
        <div class="row" data-bind="foreach:lanes">
            <div class="col text-success text-center"><h4 data-bind="text:place() === 0 ? $parent.et : time"></h4></div>
        </div>
    </div>
    <div>
        <img src="images/barcode.svg" width="10%" height="10%"/>
    </div>
    <script type='text/javascript' src='Scripts/knockout-3.4.2.js'></script>
    
    <script type='text/javascript' src='Scripts/signalr-client-1.0.0-alpha2-final.js'></script>
    <script type='text/javascript' >

        function Track(trackNumber) {
            self = this;
            this.trackNumber = trackNumber;
            this.lanes = [];
            this.et = ko.observable(0);
            this.lanes.push(new Lane());
            this.lanes.push(new Lane());
            this.lanes.push(new Lane());
            this.lanes.push(new Lane());
            this.intervalId = 0;
            this.startTimer = function() {
                self.et(0);
                self.startTime = new Date().getTime();
                self.intervalId = setInterval(self.raceTimerTick, 1000/30);
            };
            this.raceTimerTick = function(){
                self.et((new Date().getTime() - self.startTime)/1000);
            };
        }

        function Lane() {
            this.place = ko.observable(0);
            this.time = ko.observable("");
        };

        function ViewModel() {
            this.tracks = ko.observableArray();
        }
 
        let vm = new ViewModel();
        let connection = new signalR.HubConnection('/statshub');

        connection.on('setTrackCount', trackCount => {
            for(let i = 0; i < trackCount; i++)
                addTrack(i+1);
        });

        connection.on('newTrack', trackNumber => {
            addTrack(trackNumber);
        });

        connection.on('startRace', trackNumber => {
            let track = vm.tracks()[trackNumber - 1];
            clearInterval(track.intervalId);
            track.lanes.forEach(lane => {
                lane.place(0);
                lane.time("");
            })
            track.startTimer();
            console.log("Race Started on track " + trackNumber);
        });

        connection.on('laneFinished', (trackNumber, lane, place, time) => {
            let track = vm.tracks()[trackNumber - 1];
            track.lanes[lane - 1].place(place);
            track.lanes[lane - 1].time(time);
            //console.log("Lane " + lane + " place " + place + " Time " + time)
            if (place === 4)
                clearInterval(track.intervalId);
        });
        
        function addTrack(trackNumber){
            vm.tracks.push(new Track(trackNumber));
        }

        connection.start().then(() => connection.invoke('getTrackCount'));

        ko.applyBindings(vm);
        </script>
    </body>
</html>

